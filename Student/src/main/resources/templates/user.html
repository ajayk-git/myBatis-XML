<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css"
          integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.3.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.2/underscore-min.js"
            type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"
            type="text/javascript"></script>
    <title>Backbone App</title>


</head>
<body>

    <h1>User Record </h1>
    <table class="table">
        <thead>
        <tr>
            <th>userName</th>
            <th>password</th>
            <th>role</th>
        </tr>

            <tr>
                <td><input class="form-control userName-input"  placeholder="UserName"  ></td>
                <td><input class="form-control password-input" placeholder="Password" ></td>
                <td><input class="form-control role-input" placeholder="User/Admin" ></td>
<!--                 
 <td class = "Role">    
    </td>   
    <td ALIGN="left">
       <select id="selectRole">        
            <option value="Admin">Admin</option>
            <option value="User">User</option>
       </select>
    </td>   -->
                <td>
                    <button class="btn btn-primary add-user">Add</button>
                </td>
            </tr>
        </thead>
        <tbody class="users-list"></tbody>
    </table>
</div>

<script type="text/template" class="users-list-template">
    <td><span class="userName"><%= userName %></span></td>
    <td><span class="password"><%= password %></span></td>
    <td><span class="role"><%= role %></span></td>

</script>


<script type="text/javascript">

		Backbone.Model.prototype.idAttribute = 'userId';

// Backbone Model

var User = Backbone.Model.extend({
	defaults: {
		userName: 'userName',
		password: 'password',
		role: 'User',
	}
});

// Backbone Collection

var Users = Backbone.Collection.extend({
	url: 'http://localhost:8080/users/'
});

// instantiate a Collection

var users = new Users();

// Backbone View for one User

var UserView = Backbone.View.extend({
	model: new User(),
	tagName: 'tr',
	initialize: function() {
		this.template = _.template($('.users-list-template').html());
	},
	
	render: function() {
		this.$el.html(this.template(this.model.toJSON()));
		return this;
	}
});

// Backbone View for all Users

var UsersView = Backbone.View.extend({
	model: users,
	el: $('.users-list'),
	initialize: function() {
		var self = this;
		this.model.on('add', this.render, this);
		this.model.on('change', function() {
			setTimeout(function() {
				self.render();
			}, 30);
		},this);
		this.model.on('remove', this.render, this);

		this.model.fetch({
			success: function(response) {
				_.each(response.toJSON(), function(item) {
					console.log('Successfully GOT user with _id: ' + item.userId);
				})
			},
			error: function() {
				console.log('Failed to get users!');
			}
		});
	},
	render: function() {
		var self = this;
		this.$el.html('');
		_.each(this.model.toArray(), function(user) {
			self.$el.append((new UserView({model: user})).render().$el);
		});
		return this;
	}
});


var usersView = new UsersView();

$(document).ready(function() {
	$('.add-user').on('click', function() {
		var user = new User({
			userName: $('.userName-input').val(),
			password: $('.password-input').val(),
			role: $('.selectRole').val(),
		});

		$('.userName-input').val('');
		$('.password-input').val('');
		$('.role-input').val('');

		users.add(user);
		user.save(null, {
			success: function(response) {
				console.log('Successfully SAVED user with _id: ' + response.toJSON()._id);
			},
			error: function() {
				console.log('Failed to save user!');
			}
		});
	});
})

</script>
</body>
</html>